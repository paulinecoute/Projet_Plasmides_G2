{% extends "biolib/base.html" %}

{% block content %}
<div class="container mt-5">
    <h1>Résultats de la simulation #{{ simulation.id }} : {{ simulation.template.name }}</h1>

    <div class="card mb-4">
        <div class="card-header">
            <h3>Résumé de la simulation</h3>
        </div>
        <div class="card-body">
            <p><strong>Date de création :</strong> {{ simulation.date_run|date:"d F Y à H:i" }}</p>

            <p><strong>Statut :</strong>
                {% if simulation.status == 'COMPLETED' %}
                    <span class="badge bg-success">Terminée avec succès</span>
                {% elif simulation.status == 'FAILED' %}
                    <span class="badge bg-danger">Échec</span>
                {% elif simulation.status == 'RUNNING' %}
                    <span class="badge bg-warning text-dark">En cours</span>
                {% else %}
                    <span class="badge bg-secondary">En attente</span>
                {% endif %}
            </p>

            <p><strong>Template utilisé :</strong> {{ simulation.template.name }} (Enzyme: {{ simulation.template.enzyme }})</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h3>Fichiers de sortie générés</h3>
        </div>
        <div class="card-body">

            {% if simulation.status == 'COMPLETED' %}
            <div class="accordion" id="resultFilesAccordion">

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#dilutionFiles">
                            Dilution Files (CSV/Excel)
                        </button>
                    </h2>
                    <div id="dilutionFiles" class="accordion-collapse collapse show" data-bs-parent="#resultFilesAccordion">
                        <div class="accordion-body">
                            <p>Volumes à prélever pour chaque partie génétique.</p>
                            <ul>
                                <li>dilutions_calculated.csv</li>
                            </ul>

                            <a href="{% url 'download_simulation_csv' pk=simulation.id %}" class="btn btn-sm btn-success">
                                <i class="fas fa-download"></i> Télécharger le CSV
                            </a>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#gelSimulation">
                            Gel Simulation (Image)
                        </button>
                    </h2>
                    <div id="gelSimulation" class="accordion-collapse collapse" data-bs-parent="#resultFilesAccordion">
                        <div class="accordion-body">
                            <p>Simulation virtuelle du gel d'électrophorèse.</p>

                            <div class="text-center mb-3">
                                <img src="{{ MEDIA_URL }}simulations/{{ simulation.id }}/simulated_gel.png" alt="Gel Simulation" class="img-fluid border rounded" style="max-height: 400px;">
                            </div>

                            <ul>
                                <li>simulated_gel.png</li>
                            </ul>
                            <a href="{{ MEDIA_URL }}simulations/{{ simulation.id }}/simulated_gel.png" target="_blank" class="btn btn-sm btn-primary">
                                <i class="fas fa-eye"></i> Voir en grand
                            </a>
                            <a href="{{ MEDIA_URL }}simulations/{{ simulation.id }}/simulated_gel.png" download class="btn btn-sm btn-secondary">
                                <i class="fas fa-download"></i> Télécharger l'image
                            </a>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#plasmidMaps">
                            Plasmid Maps & Autres (Non générés par le Mock)
                        </button>
                    </h2>
                    <div id="plasmidMaps" class="accordion-collapse collapse" data-bs-parent="#resultFilesAccordion">
                        <div class="accordion-body text-muted">
                            <p>Ces fichiers seront disponibles lorsque l'algorithme complet sera connecté (Actuellement en mode Démo/Mock).</p>
                        </div>
                    </div>
                </div>

            </div>
            {% else %}
                <div class="alert alert-warning">
                    Les fichiers ne sont pas disponibles car la simulation n'est pas terminée.
                </div>
            {% endif %}

        </div>
    </div>

    <div class="text-center mb-4">
        <a href="{% url 'simulation_list' %}" class="btn btn-link">← Retour à la liste des simulations</a>
    </div>
</div>
{% endblock %}
