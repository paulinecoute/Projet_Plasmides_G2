{% extends "biolib/base.html" %}

{% block content %}
<div class="container mt-5">
    <h1>R√©sultats de la simulation #{{ simulation.id }}</h1>

    <div class="card mb-4">
        <div class="card-header">
            <h3>R√©sum√© de la simulation</h3>
        </div>
        <div class="card-body">
            <p><strong>Date de cr√©ation :</strong> {{ simulation.date_run|date:"d F Y √† H:i" }}</p>

            <p><strong>Statut :</strong>
                {% if simulation.status == 'COMPLETED' %}
                    <span class="badge bg-success">Termin√©e avec succ√®s</span>
                {% elif simulation.status == 'FAILED' %}
                    <span class="badge bg-danger">√âchec</span>
                {% elif simulation.status == 'RUNNING' %}
                    <span class="badge bg-warning text-dark">En cours</span>
                {% else %}
                    <span class="badge bg-secondary">En attente</span>
                {% endif %}
            </p>

            <p>
                <strong>Fichier Template :</strong>
                {% if simulation.template_file %}
                    {{ simulation.template_file.name }}
                {% else %}
                    <em>Inconnu</em>
                {% endif %}
                <br>
                <strong>Enzyme :</strong> {{ simulation.enzyme }}
            </p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h3>Fichiers de sortie g√©n√©r√©s</h3>
        </div>
        <div class="card-body">

            {% if simulation.status == 'COMPLETED' %}
            <div class="accordion" id="resultFilesAccordion">

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingZip">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#zipFiles" aria-expanded="true" aria-controls="zipFiles">
                            <i class="fas fa-file-archive me-2"></i> <strong>Tout t√©l√©charger (.zip)</strong>
                        </button>
                    </h2>
                    <div id="zipFiles" class="accordion-collapse collapse show" aria-labelledby="headingZip" data-bs-parent="#resultFilesAccordion">
                        <div class="accordion-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <p class="mb-0">Ce dossier compress√© contient l'ensemble des r√©sultats :</p>
                                    <ul class="mb-0 text-muted small">
                                        <li>üß¨ Tous les fichiers GenBank (.gb)</li>
                                        <li>üìä Les fichiers de dilutions (.csv)</li>
                                        <li>üìÑ Le rapport HTML</li>
                                    </ul>
                                </div>
                                <div class="col-md-4 text-end">
                                    <a href="{% url 'download_simulation_zip' pk=simulation.id %}" class="btn btn-primary">
                                        <i class="fas fa-download"></i> T√©l√©charger le ZIP
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingDilution">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dilutionFiles" aria-expanded="false" aria-controls="dilutionFiles">
                            <i class="fas fa-file-csv me-2"></i> Fichier de Dilutions (CSV)
                        </button>
                    </h2>
                    <div id="dilutionFiles" class="accordion-collapse collapse" aria-labelledby="headingDilution" data-bs-parent="#resultFilesAccordion">
                        <div class="accordion-body">
                            <p>Tableau contenant les volumes √† pr√©lever pour chaque partie.</p>
                            <ul>
                                <li>dilutions_calculated.csv</li>
                            </ul>

                            <a href="{% url 'download_simulation_csv' pk=simulation.id %}" class="btn btn-sm btn-success">
                                <i class="fas fa-download"></i> T√©l√©charger le CSV seul
                            </a>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingGel">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#gelSimulation" aria-expanded="false" aria-controls="gelSimulation">
                            <i class="fas fa-image me-2"></i> Gel Virtuel (Digestion)
                        </button>
                    </h2>
                    <div id="gelSimulation" class="accordion-collapse collapse" aria-labelledby="headingGel" data-bs-parent="#resultFilesAccordion">
                        <div class="accordion-body">
                            <p>Visualisation de la digestion virtuelle.</p>

                            <div class="text-center mb-3">
                                {% if simulation.result_file %}
                                    <img src="{{ MEDIA_URL }}{{ simulation.result_file }}"
                                         alt="R√©sultat Simulation"
                                         class="img-fluid border rounded"
                                         style="max-height: 500px; background-color: white;">
                                {% else %}
                                    <div class="alert alert-warning">Image non disponible.</div>
                                {% endif %}
                            </div>

                            {% if simulation.result_file %}
                                <a href="{{ MEDIA_URL }}{{ simulation.result_file }}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> Voir en grand
                                </a>
                                <a href="{{ MEDIA_URL }}{{ simulation.result_file }}" download class="btn btn-sm btn-secondary">
                                    <i class="fas fa-download"></i> T√©l√©charger l'image
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

            </div>
            {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-hourglass-half"></i> Les fichiers ne sont pas encore disponibles.
                    {% if simulation.status == 'FAILED' %}
                    <br><strong>La simulation a rencontr√© une erreur. Veuillez v√©rifier vos fichiers d'entr√©e.</strong>
                    {% endif %}
                </div>
            {% endif %}

        </div>
    </div>

    <div class="text-center mb-4">
        <a href="{% url 'simulation_list' %}" class="btn btn-link">‚Üê Retour √† la liste des simulations</a>
    </div>
</div>
{% endblock %}
