{% extends "biolib/base.html" %}

{% block content %}
<style>
  :root {
    --bg-main: #fcfcfc;
    --border-color: #eee;
  }

  body { background-color: var(--bg-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }

  .content-wrapper {
    max-width: 900px;
    margin: 0 auto;
    padding-bottom: 50px;
  }

  .nav-header { padding: 20px 0; margin-bottom: 10px; }
  
  .btn-back {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: #fff;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    color: #666;
    transition: 0.2s;
    text-decoration: none;
  }
  .btn-back:hover { border-color: #000; color: #000; }

  /* Header & Badges */
  .hero-section { margin-bottom: 40px; }
  .page-title { font-weight: 850; font-size: 2.5rem; letter-spacing: -0.05em; margin-bottom: 10px; }
  
  .visibility-badge {
    font-size: 0.7rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 6px 14px;
    border-radius: 50px;
  }
  .badge-private { background: #fff1f2; color: #e11d48; border: 1px solid #fecdd3; }
  .badge-public { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
  .badge-team { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }

  /* Cards */
  .info-card {
    background: #fff;
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 25px;
  }

  .section-label {
    font-size: 0.75rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #aaa;
    margin-bottom: 20px;
    display: block;
  }

  /* Table Custom */
  .table-custom { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
  .table-custom th { 
    font-size: 0.7rem; 
    text-transform: uppercase; 
    color: #999; 
    padding: 10px 15px; 
    font-weight: 800;
  }
  .table-custom td { 
    background: #fff; 
    border-top: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    padding: 15px; 
    font-size: 0.9rem;
  }
  .table-custom td:first-child { border-left: 1px solid var(--border-color); border-radius: 12px 0 0 12px; }
  .table-custom td:last-child { border-right: 1px solid var(--border-color); border-radius: 0 12px 12px 0; }

  .prop-label { font-size: 0.85rem; color: #888; margin-bottom: 2px; }
  .prop-value { font-weight: 700; color: #111; margin-bottom: 15px; }

  /* Actions Footer */
  .action-bar {
    position: sticky;
    bottom: 20px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 15px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 40px;
  }

  .btn-action {
    font-size: 0.85rem;
    font-weight: 600;
    padding: 10px 20px;
    border-radius: 12px;
    transition: 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
</style>

<div class="container pb-5">
  <div class="content-wrapper">
    
    <div class="nav-header">
      <a href="{% url 'template' %}" class="btn-back shadow-sm">
        <i class="bi bi-arrow-left"></i>
      </a>
    </div>

    <div class="hero-section">
      <div class="mb-2">
        {% if template.visibility == 'private' %}
            <span class="visibility-badge badge-private">Privé</span>
        {% elif template.visibility == 'public' %}
            <span class="visibility-badge badge-public">Public</span>
        {% else %}
            <span class="visibility-badge badge-team">Équipe {% if template.team %}: {{ template.team.name }}{% endif %}</span>
        {% endif %}
      </div>
      <h1 class="page-title">{{ template.name }}</h1>
      <p class="text-muted">{{ template.description|default:"Aucune description pour ce template." }}</p>
    </div>

    <span class="section-label">Propriétés de l'assemblage</span>
    <div class="info-card shadow-sm">
      <div class="row">
        <div class="col-md-4">
          <div class="prop-label">Enzyme de restriction</div>
          <div class="prop-value">{{ template.enzyme }}</div>
        </div>
        <div class="col-md-4">
          <div class="prop-label">Séparateur Output</div>
          <div class="prop-value">"{{ template.output_separator }}"</div>
        </div>
        <div class="col-md-4">
          <div class="prop-label">Nombre de parties</div>
          <div class="prop-value">{{ template.parts.count }}</div>
        </div>
        <div class="col-md-4">
          <div class="prop-label">Créé par</div>
          <div class="prop-value">{% if template.owner %}{{ template.owner.username }}{% else %}Invité{% endif %}</div>
        </div>
        <div class="col-md-8">
          <div class="prop-label">Date de création</div>
          <div class="prop-value">{{ template.created_at|date:"d M Y"|default:"Non spécifiée" }}</div>
        </div>
      </div>
    </div>

    <span class="section-label">Configuration des InputParts</span>
    <div class="table-responsive">
      <table class="table-custom">
        <thead>
          <tr>
            <th>Ordre</th>
            <th>Nom de la partie</th>
            <th>Type (Overhangs)</th>
            <th class="text-center">Nom Output</th>
            <th class="text-center">Statut</th>
          </tr>
        </thead>
        <tbody>
          {% for part in template.parts.all|dictsort:"order" %}
          <tr>
            <td class="fw-bold">#{{ part.order }}</td>
            <td class="fw-bold">{{ part.name }}</td>
            <td><code class="small text-primary">{{ part.type_id }}</code></td>
            <td class="text-center">
              {% if part.include_in_output %}
                <span class="badge rounded-pill bg-light text-dark border">Inclus</span>
              {% else %}
                <span class="text-muted opacity-25">-</span>
              {% endif %}
            </td>
            <td class="text-center">
              <div class="d-flex gap-1 justify-content-center">
                {% if part.is_mandatory %}
                  <span class="badge bg-dark" style="font-size:0.6rem">OBLIGATOIRE</span>
                {% endif %}
                {% if part.is_separable %}
                  <span class="badge border text-dark" style="font-size:0.6rem">SÉPARABLE</span>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center text-muted py-5">Aucune partie définie.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="action-bar shadow-sm">
      <a href="{% url 'template' %}" class="btn-action border text-muted">
        <i class="bi bi-list"></i> Liste
      </a>
      
      <div class="d-flex gap-2">
        {% if template.visibility != 'public' %}
            <button type="button" class="btn-action border" onclick="alert('Contactez un Administrateur pour publier ce template.')">
                <i class="bi bi-globe"></i> Publier
            </button>
        {% endif %}

        <a href="{% url 'export_template_excel' template.id %}" class="btn-action border bg-light text-success">
            <i class="bi bi-file-earmark-excel"></i> Excel
        </a>

        <a href="{% url 'create_template' %}?clone_from={{ template.id }}" class="btn-action bg-primary text-white">
            <i class="bi bi-pencil-square"></i> Modifier
        </a>

        {# Logique de suppression préservée #}
        {% if template.visibility == 'public' %}
            {% if user.is_staff %}
                <a href="{% url 'delete_template' template.id %}" class="btn-action bg-danger text-white">
                    <i class="bi bi-trash"></i>
                </a>
            {% endif %}
        {% elif template.visibility == 'team' %}
            <a href="{% url 'delete_template' template.id %}" class="btn-action bg-danger text-white">
                <i class="bi bi-trash"></i>
            </a>
        {% else %}
            {% if user == template.owner %}
                <a href="{% url 'delete_template' template.id %}" class="btn-action bg-danger text-white">
                    <i class="bi bi-trash"></i>
                </a>
            {% endif %}
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% endblock %}